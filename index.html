<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fancy Chat + Video ðŸš€</title>
  <style>
    body { margin: 0; font-family: sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; }
    .chat-container { width: 400px; height: 400px; background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; margin-top: 10px; }
    .chat-header { background: #0084ff; color: #fff; padding: 10px; text-align: center; }
    #messages { flex: 1; padding: 10px; overflow-y: auto; }
    .chat-input { display: flex; padding: 10px; background: #fafafa; }
    .chat-input input { flex: 1; padding: 8px; border-radius: 20px; border: 1px solid #ccc; }
    .chat-input button { margin-left: 8px; border: none; padding: 8px 12px; border-radius: 20px; background: #0084ff; color: white; cursor: pointer; }
    .video-container { display: flex; gap: 10px; margin-top: 20px; }
    video { width: 300px; border-radius: 8px; background: black; }
  </style>
</head>
<body>
  <h2>ðŸ’¬ Chat + ðŸŽ¥ Video Call</h2>

  <div class="chat-container">
    <div class="chat-header">Ephemeral Chat</div>
    <div id="messages"></div>
    <div class="chat-input">
      <input id="input" autocomplete="off" placeholder="Type a message...">
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <button id="callBtn">Start Video Call</button>
  <div class="video-container">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const input = document.getElementById("input");
    const messages = document.getElementById("messages");
    const sendBtn = document.getElementById("sendBtn");
    const callBtn = document.getElementById("callBtn");
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");

    const username = "User" + Math.floor(Math.random() * 1000);

    function appendMessage(msg) {
      const div = document.createElement("div");
      div.textContent = msg;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    // Chat
    sendBtn.onclick = () => {
      if (input.value) {
        socket.emit("chat message", { user: username, text: input.value });
        appendMessage("Me: " + input.value);
        input.value = "";
      }
    };

    socket.on("chat message", (data) => {
      if (data.user !== username) appendMessage(data.user + ": " + data.text);
    });

    // Video Call (WebRTC)
    let localStream;
    let peerConnection;
    const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    callBtn.onclick = async () => {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;

      peerConnection = new RTCPeerConnection(config);
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      peerConnection.onicecandidate = ({ candidate }) => {
        if (candidate) socket.emit("ice-candidate", candidate);
      };

      peerConnection.ontrack = (event) => {
        remoteVideo.srcObject = event.streams[0];
      };

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      socket.emit("offer", offer);
    };

    socket.on("offer", async (offer) => {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;

      peerConnection = new RTCPeerConnection(config);
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      peerConnection.onicecandidate = ({ candidate }) => {
        if (candidate) socket.emit("ice-candidate", candidate);
      };

      peerConnection.ontrack = (event) => {
        remoteVideo.srcObject = event.streams[0];
      };

      await peerConnection.setRemoteDescription(offer);
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      socket.emit("answer", answer);
    });

    socket.on("answer", async (answer) => {
      await peerConnection.setRemoteDescription(answer);
    });

    socket.on("ice-candidate", async (candidate) => {
      try {
        await peerConnection.addIceCandidate(candidate);
      } catch (err) {
        console.error("Error adding ice candidate", err);
      }
    });
  </script>
</body>
</html>

